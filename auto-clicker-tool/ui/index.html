<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Clicker Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        .area-selector {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            position: absolute;
            cursor: move;
        }
        
        .area-selector:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #2563eb;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-starting { background-color: #f59e0b; }
        
        .preview-window {
            border: 1px solid #d1d5db;
            background: #f9fafb;
            min-height: 200px;
            position: relative;
            overflow: hidden;
        }
        
        .click-animation {
            animation: pulse 0.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-mouse-pointer mr-3 text-blue-500"></i>
                        Auto-Clicker Tool
                    </h1>
                    <p class="text-gray-600 mt-2">Screen capture, OCR, and automated clicking</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-circle status-indicator" id="server-status"></i>
                        Server Status
                    </div>
                    <button onclick="toggleDarkMode()" class="p-2 rounded hover:bg-gray-100">
                        <i class="fas fa-moon text-gray-600"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - Area Selection -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-crop-alt mr-2 text-green-500"></i>
                        Screen Area Selection
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Area Coordinates
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="area-x" placeholder="X" class="border rounded p-2" value="100">
                                <input type="number" id="area-y" placeholder="Y" class="border rounded p-2" value="100">
                                <input type="number" id="area-width" placeholder="Width" class="border rounded p-2" value="300">
                                <input type="number" id="area-height" placeholder="Height" class="border rounded p-2" value="100">
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="selectArea()" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                <i class="fas fa-crosshairs mr-2"></i>Select Area
                            </button>
                            <button onclick="clearArea()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                <i class="fas fa-times mr-2"></i>Clear
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Preview Window
                            </label>
                            <div id="preview-window" class="preview-window rounded flex items-center justify-center">
                                <div class="text-gray-400 text-center">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>No area selected</p>
                                    <p class="text-sm">Click "Select Area" to begin</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OCR Configuration -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-eye mr-2 text-purple-500"></i>
                        OCR Configuration
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Target Pattern
                            </label>
                            <input type="text" id="target-pattern" class="w-full border rounded p-2" 
                                   value="yes|no" placeholder="yes|no">
                            <p class="text-xs text-gray-500 mt-1">Regex pattern for text detection</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Confidence Threshold
                            </label>
                            <input type="range" id="confidence" min="0.5" max="1" step="0.05" value="0.9" 
                                   class="w-full" oninput="updateConfidenceDisplay()">
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>50%</span>
                                <span id="confidence-display">90%</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Refresh Rate
                            </label>
                            <select id="refresh-rate" class="w-full border rounded p-2">
                                <option value="100">Very Fast (100ms)</option>
                                <option value="250">Fast (250ms)</option>
                                <option value="500" selected>Normal (500ms)</option>
                                <option value="1000">Slow (1000ms)</option>
                                <option value="2000">Very Slow (2000ms)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Panel - Control & Status -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-gamepad mr-2 text-red-500"></i>
                        Control Panel
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Click Action
                            </label>
                            <select id="click-action" class="w-full border rounded p-2">
                                <option value="left">Left Click</option>
                                <option value="right">Right Click</option>
                                <option value="double">Double Click</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Session Name
                            </label>
                            <input type="text" id="session-name" class="w-full border rounded p-2" 
                                   placeholder="My Auto-Clicker Session">
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="startAutoClicker()" id="start-btn" 
                                    class="flex-1 bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 font-semibold">
                                <i class="fas fa-play mr-2"></i>Start
                            </button>
                            <button onclick="stopAutoClicker()" id="stop-btn" 
                                    class="flex-1 bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 font-semibold" disabled>
                                <i class="fas fa-stop mr-2"></i>Stop
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Display -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                        Status Monitor
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">Status:</span>
                            <span id="status-text" class="text-sm font-semibold text-gray-600">Stopped</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">Session ID:</span>
                            <span id="session-id" class="text-sm text-gray-600">-</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">Last Detection:</span>
                            <span id="last-detection" class="text-sm text-gray-600">-</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">Total Clicks:</span>
                            <span id="total-clicks" class="text-sm font-semibold text-blue-600">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">Uptime:</span>
                            <span id="uptime" class="text-sm text-gray-600">0s</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">Average Confidence:</span>
                            <span id="avg-confidence" class="text-sm text-gray-600">-</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                        Quick Actions
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="saveConfig()" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                            <i class="fas fa-save mr-1"></i>Save Config
                        </button>
                        <button onclick="loadConfig()" class="bg-purple-500 text-white px-3 py-2 rounded text-sm hover:bg-purple-600">
                            <i class="fas fa-folder-open mr-1"></i>Load Config
                        </button>
                        <button onclick="testOCR()" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600">
                            <i class="fas fa-vial mr-1"></i>Test OCR
                        </button>
                        <button onclick="testClick()" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-mouse mr-1"></i>Test Click
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Activity Log -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-list-alt mr-2 text-indigo-500"></i>
                        Activity Log
                    </h2>
                    
                    <div id="activity-log" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-gray-400 text-center py-8">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>No activity yet</p>
                            <p class="text-sm">Start the auto-clicker to see activity</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex space-x-2">
                        <button onclick="clearLog()" class="flex-1 bg-gray-500 text-white px-3 py-2 rounded text-sm hover:bg-gray-600">
                            <i class="fas fa-trash mr-1"></i>Clear Log
                        </button>
                        <button onclick="exportLog()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-green-500"></i>
                        Statistics
                    </h2>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Success Rate</span>
                                <span id="success-rate">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="success-rate-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Average Response Time</span>
                                <span id="avg-response">0ms</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="response-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-gray-50 rounded p-3">
                                <div class="text-2xl font-bold text-blue-600" id="clicks-per-minute">0</div>
                                <div class="text-xs text-gray-500">Clicks/Min</div>
                            </div>
                            <div class="bg-gray-50 rounded p-3">
                                <div class="text-2xl font-bold text-green-600" id="detections-per-minute">0</div>
                                <div class="text-xs text-gray-500">Detections/Min</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSession = null;
        let selectedArea = null;
        let activityLog = [];
        let statistics = {
            totalClicks: 0,
            successfulClicks: 0,
            totalDetections: 0,
            responseTimes: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            setInterval(updateStatus, 1000);
            setInterval(updateStatistics, 5000);
        });

        // Server status check
        async function checkServerStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const statusIndicator = document.getElementById('server-status');
                statusIndicator.className = 'status-indicator status-running';
                
                logActivity('info', 'Server connected', data);
            } catch (error) {
                const statusIndicator = document.getElementById('server-status');
                statusIndicator.className = 'status-indicator status-stopped';
                
                logActivity('error', 'Server connection failed', error.message);
            }
        }

        // Area selection
        function selectArea() {
            logActivity('info', 'Area selection started', 'Click and drag on screen to select area');
            
            // This would integrate with a screen capture tool
            // For now, we'll use the manual input values
            const x = parseInt(document.getElementById('area-x').value);
            const y = parseInt(document.getElementById('area-y').value);
            const width = parseInt(document.getElementById('area-width').value);
            const height = parseInt(document.getElementById('area-height').value);
            
            selectedArea = { x, y, width, height };
            
            updatePreviewWindow();
            logActivity('success', 'Area selected', `(${x}, ${y}, ${width}x${height})`);
        }

        function clearArea() {
            selectedArea = null;
            document.getElementById('area-x').value = '';
            document.getElementById('area-y').value = '';
            document.getElementById('area-width').value = '';
            document.getElementById('area-height').value = '';
            
            updatePreviewWindow();
            logActivity('info', 'Area cleared');
        }

        function updatePreviewWindow() {
            const preview = document.getElementById('preview-window');
            
            if (selectedArea) {
                preview.innerHTML = `
                    <div class="text-center">
                        <div class="bg-blue-100 border-2 border-blue-300 rounded p-4">
                            <i class="fas fa-crop-alt text-blue-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium">Selected Area</p>
                            <p class="text-xs text-gray-600">
                                X: ${selectedArea.x}, Y: ${selectedArea.y}<br>
                                Width: ${selectedArea.width}, Height: ${selectedArea.height}
                            </p>
                        </div>
                    </div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="text-gray-400 text-center">
                        <i class="fas fa-image text-4xl mb-2"></i>
                        <p>No area selected</p>
                        <p class="text-sm">Click "Select Area" to begin</p>
                    </div>
                `;
            }
        }

        // Auto-clicker control
        async function startAutoClicker() {
            if (!selectedArea) {
                alert('Please select an area first');
                return;
            }

            const config = {
                area: selectedArea,
                targetPattern: document.getElementById('target-pattern').value,
                confidence: parseFloat(document.getElementById('confidence').value),
                clickAction: document.getElementById('click-action').value,
                refreshRate: parseInt(document.getElementById('refresh-rate').value),
                name: document.getElementById('session-name').value || 'unnamed'
            };

            try {
                const response = await fetch('/api/auto-clicker/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    currentSession = result.sessionId;
                    updateUIForRunning(true);
                    logActivity('success', 'Auto-clicker started', result);
                    
                    // Start status polling
                    startStatusPolling();
                } else {
                    logActivity('error', 'Failed to start auto-clicker', result.error);
                }
            } catch (error) {
                logActivity('error', 'Start request failed', error.message);
            }
        }

        async function stopAutoClicker() {
            if (!currentSession) return;

            try {
                const response = await fetch(`/api/auto-clicker/stop/${currentSession}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    currentSession = null;
                    updateUIForRunning(false);
                    logActivity('info', 'Auto-clicker stopped', result);
                    
                    // Stop status polling
                    stopStatusPolling();
                } else {
                    logActivity('error', 'Failed to stop auto-clicker', result.error);
                }
            } catch (error) {
                logActivity('error', 'Stop request failed', error.message);
            }
        }

        // UI updates
        function updateUIForRunning(isRunning) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusText = document.getElementById('status-text');

            if (isRunning) {
                startBtn.disabled = true;
                startBtn.className = 'flex-1 bg-gray-400 text-white px-4 py-3 rounded font-semibold cursor-not-allowed';
                stopBtn.disabled = false;
                stopBtn.className = 'flex-1 bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 font-semibold';
                statusText.textContent = 'Running';
                statusText.className = 'text-sm font-semibold text-green-600';
            } else {
                startBtn.disabled = false;
                startBtn.className = 'flex-1 bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 font-semibold';
                stopBtn.disabled = true;
                stopBtn.className = 'flex-1 bg-gray-400 text-white px-4 py-3 rounded font-semibold cursor-not-allowed';
                statusText.textContent = 'Stopped';
                statusText.className = 'text-sm font-semibold text-gray-600';
            }
        }

        // Status polling
        let statusInterval = null;

        function startStatusPolling() {
            statusInterval = setInterval(async () => {
                if (!currentSession) return;

                try {
                    const response = await fetch(`/api/auto-clicker/status/${currentSession}`);
                    const data = await response.json();

                    if (data.success) {
                        updateStatusDisplay(data);
                    }
                } catch (error) {
                    console.error('Status poll failed:', error);
                }
            }, 1000);
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        function updateStatusDisplay(data) {
            document.getElementById('session-id').textContent = data.sessionId || '-';
            document.getElementById('last-detection').textContent = data.lastDetection?.text || '-';
            document.getElementById('total-clicks').textContent = data.totalClicks || 0;
            document.getElementById('uptime').textContent = formatDuration(data.uptime || 0);
            document.getElementById('avg-confidence').textContent = data.averageConfidence ? 
                `${(data.averageConfidence * 100).toFixed(1)}%` : '-';
        }

        // Activity logging
        function logActivity(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                type,
                message,
                data
            };

            activityLog.unshift(logEntry);
            if (activityLog.length > 100) {
                activityLog.pop();
            }

            updateActivityLogDisplay();
        }

        function updateActivityLogDisplay() {
            const logContainer = document.getElementById('activity-log');
            
            if (activityLog.length === 0) {
                logContainer.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>No activity yet</p>
                        <p class="text-sm">Start the auto-clicker to see activity</p>
                    </div>
                `;
                return;
            }

            const logHTML = activityLog.map(entry => {
                const icon = getActivityIcon(entry.type);
                const color = getActivityColor(entry.type);
                
                return `
                    <div class="flex items-start space-x-2 p-2 rounded hover:bg-gray-50">
                        <i class="${icon} ${color} mt-1"></i>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${entry.message}</div>
                            <div class="text-xs text-gray-500">${entry.timestamp}</div>
                            ${entry.data ? `<div class="text-xs text-gray-600 mt-1">${JSON.stringify(entry.data, null, 2)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            logContainer.innerHTML = logHTML;
        }

        function getActivityIcon(type) {
            const icons = {
                'info': 'fas fa-info-circle',
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle'
            };
            return icons[type] || 'fas fa-circle';
        }

        function getActivityColor(type) {
            const colors = {
                'info': 'text-blue-500',
                'success': 'text-green-500',
                'error': 'text-red-500',
                'warning': 'text-yellow-500'
            };
            return colors[type] || 'text-gray-500';
        }

        // Utility functions
        function updateConfidenceDisplay() {
            const confidence = document.getElementById('confidence').value;
            document.getElementById('confidence-display').textContent = `${Math.round(confidence * 100)}%`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function clearLog() {
            activityLog = [];
            updateActivityLogDisplay();
        }

        function exportLog() {
            const logData = JSON.stringify(activityLog, null, 2);
            const blob = new Blob([logData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `auto-clicker-log-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function updateStatistics() {
            // Update statistics display
            const successRate = statistics.totalClicks > 0 ? 
                (statistics.successfulClicks / statistics.totalClicks * 100).toFixed(1) : 0;
            
            document.getElementById('success-rate').textContent = `${successRate}%`;
            document.getElementById('success-rate-bar').style.width = `${successRate}%`;

            const avgResponse = statistics.responseTimes.length > 0 ?
                (statistics.responseTimes.reduce((a, b) => a + b, 0) / statistics.responseTimes.length).toFixed(0) : 0;
            
            document.getElementById('avg-response').textContent = `${avgResponse}ms`;
            document.getElementById('response-bar').style.width = `${Math.min(avgResponse / 10, 100)}%`;

            // Calculate rates per minute
            const clicksPerMinute = statistics.totalClicks > 0 ? 
                (statistics.totalClicks / (Date.now() - statistics.startTime) * 60000).toFixed(1) : 0;
            const detectionsPerMinute = statistics.totalDetections > 0 ?
                (statistics.totalDetections / (Date.now() - statistics.startTime) * 60000).toFixed(1) : 0;

            document.getElementById('clicks-per-minute').textContent = clicksPerMinute;
            document.getElementById('detections-per-minute').textContent = detectionsPerMinute;
        }

        function updateStatus() {
            // Update any real-time status information
        }

        // Placeholder functions for future implementation
        function saveConfig() {
            logActivity('info', 'Save config - Not implemented yet');
        }

        function loadConfig() {
            logActivity('info', 'Load config - Not implemented yet');
        }

        function testOCR() {
            logActivity('info', 'Test OCR - Not implemented yet');
        }

        function testClick() {
            logActivity('info', 'Test click - Not implemented yet');
        }

        function toggleDarkMode() {
            // Dark mode implementation
            logActivity('info', 'Dark mode toggle - Not implemented yet');
        }
    </script>
</body>
</html>
